<!DOCTYPE html>
<html>
<head>
	<title>Carrito de compras</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="css/styles.css">
	<link rel="stylesheet" type="text/css" href="css/styles2.css">
	<link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.css">
	
	<!-- Bootstrap -->
	<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script type="text/javascript" src="js/cargarBase.js"></script>
	<style type="text/css">
		#search{
			margin-top: 10px;
		}
		#search_btn{
			margin-top: 10px;
			margin-left: 10px;	
		}
	</style>
</head>
<body>
	<nav class="navbar navbar-inverse navbar-fixed-top col-xs-12">
		<div class="container-fluid">
			<div class="navbar-header">
				<a href="indexLogin.html" class="navbar-brand">Tienda Online</a>
				<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navHeaderCollapse">
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
					<span class="icon-bar"></span>
				</button>
			</div>
			<div class="collapse navbar-collapse" id="navHeaderCollapse">
				<ul class="nav navbar-nav ">
					<li><a href="indexLogin.html">Inicio</a></li>
				</ul>
				<ul class="nav navbar-nav navbar-right">
					<li><a href="#" id="carritoDrop" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-shopping-cart"></span> Carrito <span class="badge" id="badgeCart">0</span></a>
						<div class="dropdown-menu" id="carrito">
							<div class="panel panel-success">
								<div class="panel-heading">
									<div class="row">
										<div class="col-xs-3">No de Prod</div>
										<div class="col-xs-3">Producto</div>
										<div class="col-xs-3">Precio</div>
									</div>
								</div>
								<div class="panel-body" id="carrito_productos"></div>
							</div>
						</div>
					</li>
					<li class="dropdown"><a href="#" class="dropdown-toggle" data-toggle="dropdown" id="nombreLogin"><span class="glyphicon glyphicon-user"></span> Mi Cuenta</a>
						<ul class="dropdown-menu">
							<li><a href="account.html">Mi cuenta</a></li>
							<li><a href="#">Historial de compras</a></li>
							<li><a href="#" id="logOut">Salir</a></li>
						</ul>
					</li>					
				</ul>
			</div>
		</div>		
	</nav>
	<section class="container-fluid padding-top">
		<p><br/></p>
		<div id="resultadoCuenta" class="col-xs-12"></div>
		<div class="col-xs-2"></div>
		<div class="col-xs-8">
			<table class="table table-striped" id="tabla-usuarios">
                    <caption>Lista de Articulos en Carrito</caption>
                    <thead>
                    	<th class="col-xs-2">No. Producto</th>
                        <th class="col-xs-2">Nombre</th>
                        <th class="col-xs-1">Precio</th>
                        <th class="col-xs-1">Cantidad</th>
                        <th class="col-xs-1">Total</th>
                        <th class="col-xs-2">Accion</th>
                    </thead>
                    <tbody id="cuerpoTabla">
                    	
                    </tbody>

            </table>
            <form action="https://www.sandbox.paypal.com/cgi-bin/webscr" method="post" id="pp">
				<input type="hidden" name="cmd" value="_cart"/>
				<input type="hidden" name="business" value="tore_oscar@hotmail.com"/>
				<input type="hidden" name="upload" value="1"/>
			</form>
        </div>
        <div class="col-xs-2"></div>
	</section>
	<footer class="container-fluid navbar-default padding-top">
			<div class="col-xs-3" id="lista-footer">
				<div class="navbar-header">
					<ul  class="nav navbar-nav">
						<li>INFORMACION</li>
					</ul>
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#footerCollapse">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
				</div>
				<div class="collapse navbar-collapse" id="footerCollapse">
						<ul id="lista-footer" class="nav navbar-nav">
								<li><a href="sobre_nosotros.html">Sobre nosotros</a></li>
								<li><a href="#">Trabaja con nosotros</a></li>
								<li><a href="#">Politicas de uso</a></li>
						</ul>
				</div>
			</div>
			<div class="col-xs-3" id="lista-footer">
				<div class="navbar-header">
					<ul  class="nav navbar-nav">
						<li>SERVICIO AL CLIENTE</li>
					</ul>
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#footerCollapse2">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
				</div>
				<div class="collapse navbar-collapse" id="footerCollapse2">
					<ul id="lista-footer" class="nav navbar-nav">
						<li><a href="#">Preguntas Frecuentes</a></li>
						<li><a href="#">Formas de pago</a></li>
						<li><a href="#">Terminos y condiciones</a></li>
					</ul>
				</div>
			</div>
			<div class="col-xs-3" id="lista-footer">
				<div class="navbar-header">
					<ul  class="nav navbar-nav">
						<li>REDES SOCIALES</li>
					</ul>
					<button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#footerCollapse3">
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
				</div>
				<div class="collapse navbar-collapse" id="footerCollapse3">
					<ul id="lista-footer" class="nav navbar-nav">
						<li><a href="#">Facebook</a></li>
						<li><a href="#">Twitter</a></li>
						<li><a href="#">Instagram</a></li>
					</ul>
				</div>
			</div>		
	</footer>


	<script src="js/jquery-3.1.1.min.js"></script>
	<script src="bootstrap/js/bootstrap.js"></script>
	<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
  	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<!-- Include all compiled plugins (below), or include individual files as needed -->
	<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
	<script  type="text/javascript">
		$(document).ready(function(){
			muestraCarrito();
			login();
			prodCarrito();
			function prodCarrito(){
				$.ajax({
					type: 'GET',
					url: 'php/index.php/?ctrl=carrito&act=badge&r=json',
					dataType: 'json',
					success: function(json){
						console.log(json);
						$('#badgeCart').text(json);
						
					}
				});
			}
			function muestraCarrito(){
				$.ajax({
				type 		: 'GET',
				url 		: 'php/index.php?ctrl=carrito&act=listar&r=json',
				dataType 	: 'json',
				success 	: function(json){
					var cuerpoTabla = document.getElementById('cuerpoTabla');
					var form 		= document.getElementById('pp');
					for(i=0;i<json.length;i++){
						cont = i + 1;
						var txtNo 		= document.createTextNode(cont);
                        var txtNombre 	= document.createTextNode(json[i].NombreProductoCart);
                   	    var txtPrecio 	= document.createTextNode('$'+json[i].PrecioCarrito);
                   	    var total       = document.createTextNode(json[i].Cantidad * json[i].PrecioCarrito);

                        var tr          	= document.createElement('tr');
                        var tdNo        	= document.createElement('td');
                        var tdNombre    	= document.createElement('td');
                        var tdPrecio    	= document.createElement('td');
                        var tdCantidad   	= document.createElement('td');
                        var tdTotal			= document.createElement('td');
                        var tdAccion    	= document.createElement('td');
                        var aElimina    	= document.createElement('a');
                        var spanElimina 	= document.createElement('span');
                        var aRefresca		= document.createElement('a');
                        var spanRefresca	= document.createElement('span');
                        var inptCantidad	= document.createElement('input');
                        var inptTotal		= document.createElement('input');
                        var inptPrecio		= document.createElement('input');
                        var inptItem		= document.createElement('input');
                        var inptNumber		= document.createElement('input');
                        var inptAmount		= document.createElement('input');
                        var inptQty			= document.createElement('input');

                        
                    
                        aElimina.setAttribute('href','#');
                        aElimina.setAttribute('onclick','return eliminaProducto(this)');
                        aElimina.setAttribute('id',json[i].IdProducto);
                        aElimina.setAttribute('class','btn btn-danger');
                        spanElimina.setAttribute('class','glyphicon glyphicon-trash');
                        aRefresca.setAttribute('href','#');
                        aRefresca.setAttribute('class','btn btn-success');
                        aRefresca.setAttribute('id',json[i].IdProducto);
                        aRefresca.setAttribute('onclick','return actualizaProducto(this)');
                        spanRefresca.setAttribute('class','glyphicon glyphicon-refresh');

                        inptItem.setAttribute('type','hidden');
                        inptItem.setAttribute('name','item_name_'+cont);
                        inptItem.setAttribute('value',json[i].NombreProductoCart);

                        inptAmount.setAttribute('type','hidden');
                        inptAmount.setAttribute('name','amount_'+cont);
                        inptAmount.setAttribute('value',json[i].PrecioCarrito);

						inptNumber.setAttribute('type','hidden');
                        inptNumber.setAttribute('name','item_number_'+cont);
                        inptNumber.setAttribute('value',cont);

                        inptQty.setAttribute('type','hidden');
                        inptQty.setAttribute('name','quantity_'+cont);
                        inptQty.setAttribute('value',json[i].Cantidad);

                        inptCantidad.setAttribute('type','text');
                        inptCantidad.setAttribute('class','form-control inpt');
                        inptCantidad.setAttribute('value',json[i].Cantidad);
                        inptCantidad.setAttribute('id',json[i].IdProducto);
                        

                        inptTotal.setAttribute('type','text');
                        inptTotal.setAttribute('class','form-control');
                        inptTotal.setAttribute('id','total'+json[i].IdProducto);
                        inptTotal.setAttribute('disabled','true');
                        inptTotal.setAttribute('value',json[i].Total);

                        inptPrecio.setAttribute('type','text');
                        inptPrecio.setAttribute('class','form-control');
                        inptPrecio.setAttribute('id','precio'+json[i].IdProducto);
                        inptPrecio.setAttribute('disabled','true');
                        inptPrecio.setAttribute('value',json[i].PrecioCarrito);
                        

                        tdNo.appendChild(txtNo);
                        tdNombre.appendChild(txtNombre);
                        tdPrecio.appendChild(inptPrecio);
                		tdCantidad.appendChild(inptCantidad);
                		tdTotal.appendChild(inptTotal);        
               	
                        aElimina.appendChild(spanElimina);
                        aRefresca.appendChild(spanRefresca);
                        
                        tdAccion.appendChild(aRefresca);
                        tdAccion.appendChild(aElimina);

                        tr.appendChild(tdNo);
                        tr.appendChild(tdNombre);
                        tr.appendChild(tdPrecio);
                        tr.appendChild(tdCantidad);
                        tr.appendChild(tdTotal);
                        tr.appendChild(tdAccion);
                        cuerpoTabla.appendChild(tr);
						form.appendChild(inptItem);
						form.appendChild(inptNumber);
						form.appendChild(inptAmount);
						form.appendChild(inptQty);
					}
					var inptImg	= document.createElement('input');
					inptImg.setAttribute('src','https://www.paypalobjects.com/webstatic/en_US/i/btn/png/blue-pill-paypal-26px.png');
					inptImg.setAttribute('type','image');
					inptImg.setAttribute('alt','PayPal');
					inptImg.setAttribute('name','submit');
					form.appendChild(inptImg);

					var inptReturn	= document.createElement('input');
					inptReturn.setAttribute('type','hidden');
					inptReturn.setAttribute('value','indexLogin.html');
					inptReturn.setAttribute('name','return');

					var inptCurrency	= document.createElement('input');
					inptCurrency.setAttribute('type','hidden');
					inptCurrency.setAttribute('value','USD');
					inptCurrency.setAttribute('name','currency_code');

					form.appendChild(inptReturn);
					form.appendChild(inptCurrency);
					form.appendChild(inptImg);
				}
				});
			}

			function login(){
				$.ajax({
					type: 'GET',
					url: 'php/index.php/?ctrl=usuarios&act=usuarioLogin&r=json',
					dataType: 'json',
					success: function(json){
						if (json == false) {
							location.href = "index.html";
						}else{
							var login = document.getElementById('nombreLogin');
							login.innerHTML = json;
						}
					}
				});
			}

		});

		$('#carritoDrop').click(function(event){
			event.preventDefault();
			$.ajax({
				type 		: 'GET',
				url 		: 'php/index.php?ctrl=carrito&act=listar&r=json',
				dataType 	: 'json',
				success 	: function(json){
					for(i=0;i<json.length;i++){
						var div = document.getElementById('carrito_productos');
						
						var divRow = document.createElement('div');
						var divPrecio = document.createElement('div');
						var divNombre = document.createElement('div');
						var divNo = document.createElement('div');
						var txtNombre = document.createTextNode(json[i].NombreProductoCart);
						var txtPrecio = document.createTextNode('$'+json[i].PrecioCarrito);

						divRow.setAttribute('class', 'row');
						divNombre.setAttribute('class', 'col-xs-3');
						divPrecio.setAttribute('class', 'col-xs-3');
						divNo.setAttribute('class', 'col-xs-3');
						var cont = i + 1;
						//divNo.appendChild(cont);
						divNo.innerHTML = cont;
						//divNo.innerHTML = cont;
						//divNo.innerHTML = cont;
						divNombre.appendChild(txtNombre);
						divPrecio.appendChild(txtPrecio);

						divRow.appendChild(divNo);
						divRow.appendChild(divNombre);
						divRow.appendChild(divPrecio);

						div.appendChild(divRow);
					
					}
				}
			});
		});

		$('body').delegate('.inpt','keyup',function(){
			var id = $(this).attr("id");
			var val = $(this).val();
			var precio = $("#precio"+id).val();
			var total = precio * val;
			$("#total"+id).val(total);
		});

		function eliminaProducto(elemento){
            var id = $(elemento).attr("id");
                $.ajax({
                    type: 'POST',
                    data: {IdProducto:id},
                    url: 'php/index.php/?ctrl=carrito&act=eliminar',
                    dataType: 'json',
                    success: function(json){
                    }
                });
                location.reload();
        }

        function actualizaProducto(elemento){
            var id 			= $(elemento).attr("id");
            var total 		= $("#total"+id).val();
            var cantidad 	= $("#"+id).val();
                $.ajax({
                    type: 'POST',
                    data: {IdProducto:id,TotalPrecio:total,CantidadProducto:cantidad},
                    url: 'php/index.php/?ctrl=carrito&act=modificar',
                    dataType: 'json',
                    success: function(json){
                    	var resultado = document.getElementById('resultadoCuenta');
                    	if (json == false){
				  			var div = document.createElement('div');
				  			div.setAttribute('class','alert alert-warning');
				  			
				  			var a = document.createElement('a');
				  			a.setAttribute('class','close');
				  			a.setAttribute('data-dismiss','alert');
				  			a.setAttribute('aria-label','close');
				  			a.innerHTML = '&times;';
				  			var p = document.createElement('p');
				  			p.innerHTML = "Debes de ingresar al menos un elemento en cantidad";
				  			div.appendChild(a);
				  			div.appendChild(p);
				  			resultado.appendChild(div);
                    	}else{
                    		var div = document.createElement('div');
				  			div.setAttribute('class','alert alert-success');
				  			
				  			var a = document.createElement('a');
				  			a.setAttribute('class','close');
				  			a.setAttribute('data-dismiss','alert');
				  			a.setAttribute('aria-label','close');
				  			a.innerHTML = '&times;';
				  			var p = document.createElement('p');
				  			p.innerHTML = "Datos actualizados";
				  			div.appendChild(a);
				  			div.appendChild(p);
				  			resultado.appendChild(div);
                    	}
                    }
                });
     	}

     	$('#logOut').click(function(event){
			event.preventDefault();
			$.ajax({
				type 		: 'GET',
				url 		: 'php/index.php?ctrl=usuarios&act=logOut&r=json',
				dataType	: 'json',
				success 	: function(json){
					if (json == true) {
						location.href = "index.html";
					}
				}
			});
		});


	</script>
</body>
</html>
